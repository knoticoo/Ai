{% extends "base.html" %}

{% block title %}Advanced Drawing Studio - ArtAI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Sidebar - Tools -->
        <div class="col-md-2 bg-light p-3">
            <h5><i class="fas fa-palette"></i> Tools</h5>
            
            <!-- Drawing Tools -->
            <div class="tool-section mb-3">
                <h6>Drawing</h6>
                <div class="btn-group-vertical w-100" role="group">
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="brush">
                        <i class="fas fa-paint-brush"></i> Brush
                    </button>
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="pencil">
                        <i class="fas fa-pencil-alt"></i> Pencil
                    </button>
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="eraser">
                        <i class="fas fa-eraser"></i> Eraser
                    </button>
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="line">
                        <i class="fas fa-minus"></i> Line
                    </button>
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="rectangle">
                        <i class="far fa-square"></i> Rectangle
                    </button>
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="circle">
                        <i class="far fa-circle"></i> Circle
                    </button>
                    <button type="button" class="btn btn-outline-primary tool-btn" data-tool="text">
                        <i class="fas fa-font"></i> Text
                    </button>
                </div>
            </div>

            <!-- Brush Settings -->
            <div class="tool-section mb-3">
                <h6>Brush</h6>
                <label>Size: <span id="brush-size-label">10</span>px</label>
                <input type="range" class="form-range" id="brush-size" min="1" max="100" value="10">
                
                <label>Opacity: <span id="opacity-label">100</span>%</label>
                <input type="range" class="form-range" id="opacity" min="1" max="100" value="100">
                
                <label>Color:</label>
                <input type="color" class="form-control" id="color-picker" value="#000000">
            </div>

            <!-- Layers -->
            <div class="tool-section mb-3">
                <h6>Layers</h6>
                <div id="layers-panel">
                    <div class="layer-item active" data-layer="0">
                        <span>Background</span>
                        <button class="btn btn-sm btn-outline-secondary">üëÅ</button>
                    </div>
                </div>
                <button class="btn btn-sm btn-primary w-100 mt-2" id="add-layer">
                    <i class="fas fa-plus"></i> Add Layer
                </button>
            </div>

            <!-- Actions -->
            <div class="tool-section">
                <h6>Actions</h6>
                <button class="btn btn-outline-secondary w-100 mb-2" id="undo">
                    <i class="fas fa-undo"></i> Undo
                </button>
                <button class="btn btn-outline-secondary w-100 mb-2" id="redo">
                    <i class="fas fa-redo"></i> Redo
                </button>
                <button class="btn btn-outline-danger w-100 mb-2" id="clear-canvas">
                    <i class="fas fa-trash"></i> Clear
                </button>
                <button class="btn btn-success w-100 mb-2" id="save-drawing">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="col-md-8">
            <div class="canvas-container position-relative">
                <canvas id="drawing-canvas" width="800" height="600" style="border: 1px solid #ddd; background: white;"></canvas>
                <div id="canvas-overlay" class="position-absolute top-0 start-0"></div>
            </div>
            
            <!-- Canvas Controls -->
            <div class="mt-3">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label>Zoom: <span id="zoom-label">100</span>%</label>
                        <input type="range" class="form-range" id="zoom-slider" min="25" max="400" value="100">
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-primary" id="fit-to-screen">Fit to Screen</button>
                        <button class="btn btn-outline-primary" id="actual-size">100%</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar - Properties & Collaboration -->
        <div class="col-md-2 bg-light p-3">
            <h5><i class="fas fa-cog"></i> Properties</h5>
            
            <!-- Canvas Settings -->
            <div class="tool-section mb-3">
                <h6>Canvas</h6>
                <label>Width:</label>
                <input type="number" class="form-control form-control-sm mb-2" id="canvas-width" value="800">
                <label>Height:</label>
                <input type="number" class="form-control form-control-sm mb-2" id="canvas-height" value="600">
                <button class="btn btn-sm btn-outline-primary w-100" id="resize-canvas">Resize</button>
            </div>

            <!-- Filters & Effects -->
            <div class="tool-section mb-3">
                <h6>Effects</h6>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-1" data-filter="blur">Blur</button>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-1" data-filter="sharpen">Sharpen</button>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-1" data-filter="brightness">Brightness</button>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-1" data-filter="contrast">Contrast</button>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-1" data-filter="sepia">Sepia</button>
                <button class="btn btn-sm btn-outline-secondary w-100 mb-1" data-filter="grayscale">Grayscale</button>
            </div>

            <!-- Collaboration -->
            <div class="tool-section mb-3">
                <h6>Collaboration</h6>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enable-collaboration">
                    <label class="form-check-label" for="enable-collaboration">
                        Enable Live Collaboration
                    </label>
                </div>
                <div id="collaborators" class="mt-2">
                    <!-- Online collaborators will appear here -->
                </div>
            </div>

            <!-- AI Assistant -->
            <div class="tool-section">
                <h6>AI Assistant</h6>
                <button class="btn btn-sm btn-outline-info w-100 mb-1" id="ai-suggest">
                    <i class="fas fa-magic"></i> Suggest Improvements
                </button>
                <button class="btn btn-sm btn-outline-info w-100 mb-1" id="ai-auto-complete">
                    <i class="fas fa-robot"></i> Auto Complete
                </button>
                <button class="btn btn-sm btn-outline-info w-100" id="ai-style-transfer">
                    <i class="fas fa-palette"></i> Style Transfer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Advanced Drawing JavaScript -->
<script>
class AdvancedDrawingCanvas {
    constructor() {
        this.canvas = document.getElementById('drawing-canvas');
        this.ctx = this.canvas.getContext('2d');
        this.isDrawing = false;
        this.currentTool = 'brush';
        this.brushSize = 10;
        this.currentColor = '#000000';
        this.opacity = 1;
        this.layers = [this.ctx];
        this.currentLayer = 0;
        this.history = [];
        this.historyStep = -1;
        this.zoom = 1;
        
        this.initializeEvents();
        this.saveState();
    }

    initializeEvents() {
        // Canvas events
        this.canvas.addEventListener('mousedown', this.startDrawing.bind(this));
        this.canvas.addEventListener('mousemove', this.draw.bind(this));
        this.canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
        this.canvas.addEventListener('mouseout', this.stopDrawing.bind(this));

        // Touch events for mobile
        this.canvas.addEventListener('touchstart', this.handleTouch.bind(this));
        this.canvas.addEventListener('touchmove', this.handleTouch.bind(this));
        this.canvas.addEventListener('touchend', this.stopDrawing.bind(this));

        // Tool buttons
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentTool = e.target.dataset.tool;
            });
        });

        // Controls
        document.getElementById('brush-size').addEventListener('input', (e) => {
            this.brushSize = e.target.value;
            document.getElementById('brush-size-label').textContent = e.target.value;
        });

        document.getElementById('opacity').addEventListener('input', (e) => {
            this.opacity = e.target.value / 100;
            document.getElementById('opacity-label').textContent = e.target.value;
        });

        document.getElementById('color-picker').addEventListener('change', (e) => {
            this.currentColor = e.target.value;
        });

        // Actions
        document.getElementById('undo').addEventListener('click', this.undo.bind(this));
        document.getElementById('redo').addEventListener('click', this.redo.bind(this));
        document.getElementById('clear-canvas').addEventListener('click', this.clearCanvas.bind(this));
        document.getElementById('save-drawing').addEventListener('click', this.saveDrawing.bind(this));

        // Zoom
        document.getElementById('zoom-slider').addEventListener('input', (e) => {
            this.setZoom(e.target.value / 100);
        });

        // AI Features
        document.getElementById('ai-suggest').addEventListener('click', this.aiSuggest.bind(this));
        document.getElementById('ai-auto-complete').addEventListener('click', this.aiAutoComplete.bind(this));
        document.getElementById('ai-style-transfer').addEventListener('click', this.aiStyleTransfer.bind(this));
    }

    startDrawing(e) {
        this.isDrawing = true;
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / this.zoom;
        const y = (e.clientY - rect.top) / this.zoom;
        
        this.ctx.beginPath();
        this.ctx.moveTo(x, y);
        this.setupBrush();
    }

    draw(e) {
        if (!this.isDrawing) return;
        
        const rect = this.canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) / this.zoom;
        const y = (e.clientY - rect.top) / this.zoom;

        switch(this.currentTool) {
            case 'brush':
            case 'pencil':
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
                break;
            case 'eraser':
                this.ctx.clearRect(x - this.brushSize/2, y - this.brushSize/2, this.brushSize, this.brushSize);
                break;
        }
    }

    stopDrawing() {
        if (this.isDrawing) {
            this.isDrawing = false;
            this.saveState();
        }
    }

    setupBrush() {
        this.ctx.lineWidth = this.brushSize;
        this.ctx.lineCap = 'round';
        this.ctx.strokeStyle = this.currentColor;
        this.ctx.globalAlpha = this.opacity;
        
        if (this.currentTool === 'pencil') {
            this.ctx.globalCompositeOperation = 'source-over';
        } else if (this.currentTool === 'eraser') {
            this.ctx.globalCompositeOperation = 'destination-out';
        } else {
            this.ctx.globalCompositeOperation = 'source-over';
        }
    }

    saveState() {
        this.historyStep++;
        if (this.historyStep < this.history.length) {
            this.history.length = this.historyStep;
        }
        this.history.push(this.canvas.toDataURL());
    }

    undo() {
        if (this.historyStep > 0) {
            this.historyStep--;
            this.restoreState();
        }
    }

    redo() {
        if (this.historyStep < this.history.length - 1) {
            this.historyStep++;
            this.restoreState();
        }
    }

    restoreState() {
        const img = new Image();
        img.onload = () => {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.ctx.drawImage(img, 0, 0);
        };
        img.src = this.history[this.historyStep];
    }

    clearCanvas() {
        if (confirm('Are you sure you want to clear the canvas?')) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            this.saveState();
        }
    }

    setZoom(zoom) {
        this.zoom = zoom;
        this.canvas.style.transform = `scale(${zoom})`;
        this.canvas.style.transformOrigin = 'top left';
        document.getElementById('zoom-label').textContent = Math.round(zoom * 100);
    }

    async saveDrawing() {
        const dataURL = this.canvas.toDataURL('image/png');
        
        try {
            const response = await fetch('/api/save_drawing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_data: dataURL,
                    title: prompt('Enter a title for your drawing:') || 'Untitled Drawing'
                })
            });

            if (response.ok) {
                alert('Drawing saved successfully!');
            } else {
                alert('Error saving drawing. Please try again.');
            }
        } catch (error) {
            console.error('Error saving drawing:', error);
            alert('Error saving drawing. Please try again.');
        }
    }

    async aiSuggest() {
        const dataURL = this.canvas.toDataURL('image/png');
        
        try {
            const response = await fetch('/api/ai_analyze_drawing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ image_data: dataURL })
            });

            const result = await response.json();
            if (result.suggestions) {
                alert('AI Suggestions:\n' + result.suggestions.join('\n'));
            }
        } catch (error) {
            console.error('Error getting AI suggestions:', error);
        }
    }

    async aiAutoComplete() {
        alert('AI Auto-complete feature coming soon!');
    }

    async aiStyleTransfer() {
        const style = prompt('Enter style (e.g., "Van Gogh", "Picasso", "Anime"):');
        if (!style) return;

        const dataURL = this.canvas.toDataURL('image/png');
        
        try {
            const response = await fetch('/api/ai_style_transfer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    image_data: dataURL,
                    style: style
                })
            });

            const result = await response.json();
            if (result.styled_image) {
                const img = new Image();
                img.onload = () => {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.drawImage(img, 0, 0);
                    this.saveState();
                };
                img.src = result.styled_image;
            }
        } catch (error) {
            console.error('Error applying style transfer:', error);
        }
    }

    handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                        e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        this.canvas.dispatchEvent(mouseEvent);
    }
}

// Initialize the drawing canvas when page loads
document.addEventListener('DOMContentLoaded', () => {
    new AdvancedDrawingCanvas();
});
</script>

<style>
.canvas-container {
    overflow: auto;
    max-height: 70vh;
}

.tool-btn.active {
    background-color: #0d6efd;
    color: white;
}

.layer-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
    border: 1px solid #ddd;
    margin-bottom: 2px;
    cursor: pointer;
}

.layer-item.active {
    background-color: #e3f2fd;
}

.tool-section {
    border-bottom: 1px solid #ddd;
    padding-bottom: 10px;
}

#drawing-canvas {
    cursor: crosshair;
}

#drawing-canvas:hover {
    cursor: crosshair;
}
</style>
{% endblock %}