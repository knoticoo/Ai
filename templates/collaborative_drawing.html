{% extends "base.html" %}

{% block title %}Collaborative Drawing - ArtAI{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Collaborative Drawing</h1>
        <p class="lead text-muted">Create art together in real-time with other artists</p>
    </div>
    
    <!-- Drawing Canvas -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-palette me-2"></i>Collaborative Canvas
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" id="brushTool">
                            <i class="fas fa-paint-brush"></i> Brush
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" id="eraserTool">
                            <i class="fas fa-eraser"></i> Eraser
                        </button>
                        <button class="btn btn-outline-danger btn-sm" id="clearCanvas">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <canvas id="drawingCanvas" width="800" height="600" style="border: 1px solid #ddd; width: 100%; max-width: 800px; cursor: crosshair;"></canvas>
                </div>
                <div class="card-footer">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="brushSize" class="form-label me-2 mb-0">Size:</label>
                                <input type="range" class="form-range me-3" id="brushSize" min="1" max="50" value="5" style="width: 100px;">
                                <input type="color" class="form-control form-control-color" id="brushColor" value="#000000" style="width: 50px; height: 38px;">
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-success" id="saveArtwork">
                                <i class="fas fa-save me-2"></i>Save Artwork
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Participants Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-users me-2"></i>Active Artists (<span id="participantCount">1</span>)
                    </h6>
                </div>
                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                    <div id="participantsList">
                        <div class="d-flex align-items-center mb-3">
                            <div class="avatar-sm me-2">
                                <i class="fas fa-user-circle fa-2x text-primary"></i>
                            </div>
                            <div>
                                <div class="fw-bold">{{ current_user.username if current_user.is_authenticated else 'Guest' }}</div>
                                <small class="text-muted">You</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Chat
                    </h6>
                </div>
                <div class="card-body p-0">
                    <div id="chatMessages" style="height: 200px; overflow-y: auto; padding: 10px;">
                        <div class="text-muted text-center py-3">
                            Welcome to collaborative drawing! Start chatting with other artists.
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    {% if current_user.is_authenticated %}
                    <div class="input-group">
                        <input type="text" class="form-control" id="chatInput" placeholder="Type a message..." maxlength="200">
                        <button class="btn btn-primary" id="sendMessage">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center">
                        <a href="{{ url_for('login') }}" class="btn btn-primary btn-sm">
                            Login to chat
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructions -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">
                <i class="fas fa-info-circle me-2 text-info"></i>How to Collaborate
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-mouse-pointer text-primary me-2"></i>
                            Use your mouse or touch to draw on the canvas
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-palette text-primary me-2"></i>
                            Choose different brush sizes and colors
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-comments text-primary me-2"></i>
                            Communicate with other artists through chat
                        </li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-handshake text-success me-2"></i>
                            Be respectful and collaborative
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-lightbulb text-success me-2"></i>
                            Share ideas and learn from others
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-save text-success me-2"></i>
                            Save your collaborative artwork when finished
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    const brushSizeInput = document.getElementById('brushSize');
    const brushColorInput = document.getElementById('brushColor');
    const chatInput = document.getElementById('chatInput');
    
    let isDrawing = false;
    let currentTool = 'brush';
    
    // Set up canvas
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    
    // Drawing functions
    function startDrawing(e) {
        isDrawing = true;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(x * (canvas.width / rect.width), y * (canvas.height / rect.height));
    }
    
    function draw(e) {
        if (!isDrawing) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX || e.touches[0].clientX) - rect.left;
        const y = (e.clientY || e.touches[0].clientY) - rect.top;
        
        ctx.lineWidth = brushSizeInput.value;
        ctx.strokeStyle = currentTool === 'eraser' ? '#FFFFFF' : brushColorInput.value;
        ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
        
        ctx.lineTo(x * (canvas.width / rect.width), y * (canvas.height / rect.height));
        ctx.stroke();
    }
    
    function stopDrawing() {
        isDrawing = false;
        ctx.beginPath();
    }
    
    // Event listeners
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        startDrawing(e);
    });
    canvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        draw(e);
    });
    canvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        stopDrawing();
    });
    
    // Tool selection
    document.getElementById('brushTool').addEventListener('click', function() {
        currentTool = 'brush';
        this.classList.add('btn-primary');
        this.classList.remove('btn-outline-primary');
        document.getElementById('eraserTool').classList.add('btn-outline-secondary');
        document.getElementById('eraserTool').classList.remove('btn-secondary');
        canvas.style.cursor = 'crosshair';
    });
    
    document.getElementById('eraserTool').addEventListener('click', function() {
        currentTool = 'eraser';
        this.classList.add('btn-secondary');
        this.classList.remove('btn-outline-secondary');
        document.getElementById('brushTool').classList.add('btn-outline-primary');
        document.getElementById('brushTool').classList.remove('btn-primary');
        canvas.style.cursor = 'cell';
    });
    
    document.getElementById('clearCanvas').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear the canvas?')) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    });
    
    // Chat functionality
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
        
        document.getElementById('sendMessage').addEventListener('click', sendChatMessage);
    }
    
    function sendChatMessage() {
        const message = chatInput.value.trim();
        if (message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-2';
            messageDiv.innerHTML = `
                <div class="d-flex">
                    <small class="fw-bold text-primary me-2">{{ current_user.username if current_user.is_authenticated else 'You' }}:</small>
                    <small>${message}</small>
                </div>
            `;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            chatInput.value = '';
        }
    }
    
    // Save artwork
    document.getElementById('saveArtwork').addEventListener('click', function() {
        const dataURL = canvas.toDataURL('image/png');
        
        // Create a download link
        const link = document.createElement('a');
        link.download = 'collaborative_artwork_' + new Date().getTime() + '.png';
        link.href = dataURL;
        link.click();
        
        // You could also send this to the server to save in the gallery
        // fetch('/save_collaborative_artwork', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({ image: dataURL })
        // });
    });
});
</script>
{% endblock %}